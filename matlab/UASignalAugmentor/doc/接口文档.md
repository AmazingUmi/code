# UASignalAugmentor 接口文档

## 文档说明

本文档提供 UASignalAugmentor 项目所有函数接口的详细说明，包括输入输出参数、功能描述、使用示例等。

---

## 目录

- [1. 数据加载与环境处理](#1-数据加载与环境处理)
- [2. 坐标与地形处理](#2-坐标与地形处理)
- [3. 声速剖面处理](#3-声速剖面处理)
- [4. 边界条件与反射系数](#4-边界条件与反射系数)
- [5. 信号处理](#5-信号处理)
- [6. 文件写入工具](#6-文件写入工具)
- [7. 高级功能](#7-高级功能)

---

## 1. 数据加载与环境处理

### 1.1 load_data

**功能**：加载海洋环境数据（地形和声速剖面）

**语法**：
```matlab
[ETOPO, WOA23] = load_data(OceanDataPath, ETOPOName, WOAName)
```

**输入参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `OceanDataPath` | char | 海洋数据文件夹路径 |
| `ETOPOName` | char | ETOPO地形数据文件名 |
| `WOAName` | char | WOA23数据文件名格式（包含 %d 占位符，如 'woa23_%02d.mat'） |

**输出参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `ETOPO` | struct | ETOPO地形数据结构体，包含 `.Lon`, `.Lat`, `.Altitude` |
| `WOA23` | struct | WOA23声速剖面数据结构体 |
| `WOA23.Lat` | struct | 纬度数据 |
| `WOA23.Lon` | struct | 经度数据 |
| `WOA23.Data` | cell(1,17) | 温盐深数据（1-12: 月数据, 13-16: 季数据, 17: 年数据） |

**数据索引说明**：
- 文件名索引: 01-12(月), 13-16(季), 00(年)
- 提取后索引: 1-12(月), 13-16(季), 17(年)

**使用示例**：
```matlab
% 加载海洋数据
OceanDataPath = 'c:\DataBase\code\matlab\UASignalAugmentor\data\OceanData';
ETOPOName = 'ETOPO2022.mat';
WOAName = 'woa23_%02d.mat';
[ETOPO, WOA23] = load_data(OceanDataPath, ETOPOName, WOAName);
```

---

### 1.2 get_env

**功能**：获取指定区域的海深和声速剖面数据

**语法**：
```matlab
[Depth, ssp_raw, SSP] = get_env(ETOPO, WOA, lon, lat, timeIdx)
```

**输入参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `ETOPO` | struct | ETOPO地形数据结构体 |
| `WOA` | struct | WOA23声速剖面数据结构体 |
| `lon` | double[] | 目标经度向量 |
| `lat` | double[] | 目标纬度向量 |
| `timeIdx` | int | 时间索引（1-12: 月份, 13-16: 季节, 17: 年平均） |

**输出参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `Depth` | double[] | 指定区间上的海深向量 (m) |
| `ssp_raw` | double[N×2] | 区间平均声速剖面 [深度, 声速]，用于 *.env 文件 |
| `SSP` | struct | 区间多点声速剖面集合结构体，用于 *.ssp 文件 |
| `SSP.z` | double[] | 深度向量 (m) |
| `SSP.c` | double[Nz×Nr] | 声速矩阵 |

**功能说明**：
1. 提取指定区间的海底地形和声速剖面
2. 提取温盐剖面并计算平均值
3. 扩展声速剖面至最大海深
4. 生成 *.env 和 *.ssp 文件所需的声速剖面数据
5. 用平均值填充 NaN 数据

**使用示例**：
```matlab
% 提取海洋环境数据
lon = linspace(115, 117, 100);
lat = linspace(20, 22, 100);
timeIdx = 1;  % 一月份数据
[Depth, ssp_raw, SSP] = get_env(ETOPO, WOA23, lon, lat, timeIdx);
```

---

### 1.3 get_envInfo

**功能**：提取给定坐标和时间的温盐深数据

**语法**：
```matlab
[Temp, Sal, Depth] = get_envInfo(WOA, lon, lat, timeIdx)
```

**输入参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `WOA` | struct | WOA23声速剖面数据结构体 |
| `lon` | double[] | 目标经度向量 |
| `lat` | double[] | 目标纬度向量 |
| `timeIdx` | int | 时间索引（1-12: 月份, 13-16: 季节, 17: 年平均） |

**输出参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `Temp` | double[Ndepth×Nlon] | 温度剖面 (°C) |
| `Sal` | double[Ndepth×Nlon] | 盐度剖面 (PSU) |
| `Depth` | double[] | 深度向量 (m) |

**特殊说明**：
- 1-12月份剖面深度为1500米，季度或全年平均剖面深度为5500米
- 提取1-12月份剖面时，1500米以下用全年剖面数据填充

**使用示例**：
```matlab
[Temp, Sal, Depth] = get_envInfo(WOA23, lon, lat, 1);
```

---

## 2. 坐标与地形处理

### 2.1 coord_proc

**功能**：坐标、距离和方位信息的相互转换和补充

**语法**：
```matlab
[coordS, coordE, R, azi] = coord_proc(coordS, coordE, R, azi)
```

**输入/输出参数**（灵活组合）：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `coordS` | struct | 起点坐标，包含 `.lon`（经度）, `.lat`（纬度） |
| `coordE` | struct | 终点坐标，包含 `.lon`, `.lat` |
| `R` | double | 起点到终点的距离 (km) |
| `azi` | double | 起点到终点的方位角 (度，正北为0°，顺时针增大) |

**使用模式**：

**模式1**：输入起点和终点，计算距离和方位
```matlab
coordS.lon = 115.0;
coordS.lat = 20.0;
coordE.lon = 116.0;
coordE.lat = 21.0;
[coordS, coordE, R, azi] = coord_proc(coordS, coordE, [], []);
% 输出: R (距离), azi (方位角)
```

**模式2**：输入起点、距离和方位，计算终点
```matlab
coordS.lon = 115.0;
coordS.lat = 20.0;
R = 100;  % km
azi = 45;  % 度
[coordS, coordE, R, azi] = coord_proc(coordS, [], R, azi);
% 输出: coordE (终点坐标)
```

---

### 2.2 get_bathm

**功能**：从ETOPO数据库插值获取海深数据

**语法**：
```matlab
depth = get_bathm(ETOPO, lon, lat)
```

**输入参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `ETOPO` | struct | ETOPO地形数据结构体 |
| `lon` | double | 目标经度（标量、向量或矩阵） |
| `lat` | double | 目标纬度（标量、向量或矩阵） |

**输出参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `depth` | double | 对应经纬度的海深值（m），正值表示水深 |

**使用示例**：
```matlab
% 单点查询
depth = get_bathm(ETOPO, 115.5, 20.3);

% 直线查询
depth = get_bathm(ETOPO, [115, 116, 117], [20, 20.5, 21]);

% 网格查询
[lon_grid, lat_grid] = meshgrid(115:0.1:117, 20:0.1:22);
depth = get_bathm(ETOPO, lon_grid, lat_grid);
```

---

## 3. 声速剖面处理

### 3.1 add_mesoscale

**功能**：向声速剖面添加中尺度现象（高斯涡或内波）

**语法**：
```matlab
SSP = add_mesoscale(SSP, rmax, phenomenon_type, params)
```

**输入参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `SSP` | struct | 声速剖面结构体（包含 `.z` 和 `.c`） |
| `rmax` | double | 最大距离范围 (km) |
| `phenomenon_type` | char | 现象类型: 'none', 'eddy', 'internal_wave' |
| `params` | struct | 现象参数（根据类型不同） |

**输出参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `SSP` | struct | 更新后的声速剖面结构体 |

**现象类型与参数**：

#### 3.1.1 无中尺度现象 ('none')
```matlab
SSP_new = add_mesoscale(SSP, 200, 'none');
% params 可省略
```

#### 3.1.2 高斯涡 ('eddy')
**参数字段**：
| 字段 | 类型 | 说明 |
|------|------|------|
| `params.rc` | double | 涡心水平位置 (km) |
| `params.zc` | double | 涡心竖直位置 (m) |
| `params.DR` | double | 涡水平尺度 (km) |
| `params.DZ` | double | 涡竖直尺度 (m) |
| `params.DC` | double | 涡的强度 (m/s，负值为冷涡，正值为暖涡) |

```matlab
eddy_params.rc = 100;  % 涡心在100km处
eddy_params.zc = 600;  % 涡心深度600m
eddy_params.DR = 70;   % 水平尺度70km
eddy_params.DZ = 400;  % 竖直尺度400m
eddy_params.DC = -40;  % 冷涡，强度-40 m/s
SSP_new = add_mesoscale(SSP, 200, 'eddy', eddy_params);
```

#### 3.1.3 内波 ('internal_wave')
**参数字段**：
| 字段 | 类型 | 说明 | 默认值 |
|------|------|------|--------|
| `params.z0` | double | 内波基准深度 (m) | - |
| `params.L` | double | 特征长度 (km) | - |
| `params.rc` | double | 波峰中心所在距离 (km) | - |
| `params.DC` | double | 内波强度 (m) | - |
| `params.k1` | int | 上层插值点数 | 20 |
| `params.k2` | int | 下层插值点数 | 50 |

```matlab
iw_params.z0 = 1000;   % 基准深度1000m
iw_params.L = 40;      % 特征长度40km
iw_params.rc = 100;    % 波峰中心100km
iw_params.DC = 500;    % 内波强度500m
SSP_new = add_mesoscale(SSP, 200, 'internal_wave', iw_params);
```

---

## 4. 边界条件与反射系数

### 4.1 ReCoeTop

**功能**：计算海面反射系数（粗糙海面模型）

**语法**：
```matlab
result_R = ReCoeTop(freqvec, c_surface, sea_state_level, out_filename)
```

**输入参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `freqvec` | double[] | 频率向量 (Hz) |
| `c_surface` | double | 海面声速 (m/s) |
| `sea_state_level` | int | 海况等级（0-9） |
| `out_filename` | char | 输出文件名（不含扩展名） |

**输出参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `result_R` | double[N×3] | 反射系数矩阵 [角度, 幅值, 相位] |

**海况等级对应波高**：
| 等级 | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 |
|------|---|---|---|---|---|---|---|---|---|
| 波高(m) | 0 | 0.1 | 0.5 | 1.25 | 2.5 | 4 | 6 | 9 | 14 |

**输出文件**：`out_filename.trc`（ASCII格式）

**使用示例**：
```matlab
freqvec = [100, 200, 500, 1000];
c_surface = 1520;
sea_state_level = 3;
result_R = ReCoeTop(freqvec, c_surface, sea_state_level, 'test');
% 生成文件: test.trc
```

---

### 4.2 RefCoeBw

**功能**：根据海底参数计算海底反射系数（多层介质模型）

**语法**：
```matlab
result_R = RefCoeBw(base_type, envfil, freqvec, ssp_end, alpha_b)
```

**输入参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `base_type` | char | 海底类型: 'IMG', 'D05', 'D40', 'SCS-4' |
| `envfil` | char | 输出文件名（不含扩展名） |
| `freqvec` | double[] | 频率向量 (Hz) |
| `ssp_end` | double | 海底声速 (m/s) |
| `alpha_b` | double | 底质吸收系数 (dB/λ) |

**输出参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `result_R` | double[N×3] | 反射系数矩阵 [掠射角, 幅值, 相位] |

**海底类型说明**：
| 类型 | 说明 |
|------|------|
| `IMG` | 简单镜像海底（半空间） |
| `D05` | 实测底质类型1（多层介质） |
| `D40` | 实测底质类型2（多层介质） |
| `SCS-4` | 南海实测底质类型 |

**输出文件**：`envfil.brc`（ASCII格式）

**使用示例**：
```matlab
base_type = 'IMG';
freqvec = [100, 500, 1000];
ssp_end = 1500;
alpha_b = 0.05;
result_R = RefCoeBw(base_type, 'test', freqvec, ssp_end, alpha_b);
% 生成文件: test.brc
```

---

### 4.3 get_boundary_speed

**功能**：从环境文件文本中提取表面和海底声速

**语法**：
```matlab
[ssp_top, ssp_bot] = get_boundary_speed(BaseLines)
```

**输入参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `BaseLines` | cell | 环境文件各行文本的 cell 数组 |

**输出参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `ssp_top` | double | 海面声速 (m/s) |
| `ssp_bot` | double | 海底声速 (m/s) |

**使用示例**：
```matlab
FileContents = fileread('ENV_1_Rr5Km.env');
BaseLines = strsplit(FileContents, '\n');
[ssp_top, ssp_bot] = get_boundary_speed(BaseLines);
```

---

## 5. 信号处理

### 5.1 wavfreq

**功能**：音频信号频率分析，提取频率成分、幅值和相位

**语法**：
```matlab
[fs, Ndelay, Analyrecord, Analy_freq] = wavfreq(audioname, FreqRange, cut_Tlength)
```

**输入参数**：
| 参数名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| `audioname` | char | 音频文件路径 | - |
| `FreqRange` | double[1×2] | 频率范围 [最小, 最大] (Hz) | [10, 5000] |
| `cut_Tlength` | double | 信号分段时间长度（秒） | 1 |

**输出参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `fs` | double | 音频采样频率 (Hz) |
| `Ndelay` | double[] | 各段信号的时间延迟数组（秒） |
| `Analyrecord` | struct[] | 结构体数组，包含每段信号的频率分析结果 |
| `Analyrecord(i).Amp` | double[] | 第i段频率分量的幅值 |
| `Analyrecord(i).freq` | double[] | 第i段频率分量的频率值 (Hz) |
| `Analyrecord(i).phase` | double[] | 第i段频率分量的相位（弧度） |
| `Analy_freq` | double[] | 所有信号段的频率集合（去重后） |

**功能说明**：
1. 读取音频文件并获取采样频率
2. 根据指定时间长度将信号分段
3. 对每段信号进行FFT变换，提取频率成分
4. 滤除指定频率范围外的分量
5. 按幅值降序排列频率分量

**使用示例**：
```matlab
% 基本用法
[fs, Ndelay, Analyrecord, Analy_freq] = wavfreq('ship_signal.wav', [10, 5000], 1);

% 自定义频率范围
[fs, Ndelay, Analyrecord, Analy_freq] = wavfreq('ship_signal.wav', [50, 3000], 0.5);
```

---

### 5.2 wavfilter

**功能**：信号频率分量幅值筛选，保留高幅值分量

**语法**：
```matlab
[Analyrecord_filtered, Analy_freq_filtered] = wavfilter(Analyrecord, threshold)
```

**输入参数**：
| 参数名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| `Analyrecord` | struct[] | 分析记录结构体数组（wavfreq 输出） | - |
| `threshold` | double | 幅值阈值比例 | 0.05 |

**输出参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `Analyrecord_filtered` | struct[] | 筛选后的分析记录结构体数组 |
| `Analy_freq_filtered` | double[] | 筛选后所有信号段的频率集合（去重后） |

**阈值说明**：
保留幅值 >= `threshold × 最大幅值` 的频率分量

**使用示例**：
```matlab
% 使用默认阈值（5%）
[Analyrecord_filtered, Analy_freq_filtered] = wavfilter(Analyrecord);

% 自定义阈值（10%）
[Analyrecord_filtered, Analy_freq_filtered] = wavfilter(Analyrecord, 0.1);
```

---

### 5.3 SigGenerateTD

**功能**：通过时域叠加生成多径衰落信号

**语法**：
```matlab
[y_time, M] = SigGenerateTD(freq, T, fs, amp0, phase0, delay, amp, phase)
```

**输入参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `freq` | double | 原信号频率 (Hz) |
| `T` | double | 原信号持续时间（秒） |
| `fs` | double | 采样率 (Hz) |
| `amp0` | double | 原信号幅度标量 |
| `phase0` | double | 原信号初相位（弧度） |
| `delay` | double[P] | 各径时延向量（秒） |
| `amp` | double[P] | 各径幅值向量 |
| `phase` | double[P] | 各径附加相位向量（弧度） |

**输出参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `y_time` | double[1×M] | 多径信号复数形式（行向量） |
| `M` | int | 输出信号采样点数 |

**算法说明**：
1. 构造复值基带信号：`s = amp0 * exp(1j*(2*pi*freq*t + phase0))`
2. 时延归零处理
3. 计算输出长度：原长 + 最大时延 + 10ms 余量
4. 叠加各径：`y = Σ amp(i) * s * exp(1j*phase(i))`

**使用示例**：
```matlab
freq = 500;  % Hz
T = 1;  % 秒
fs = 52734;  % Hz
amp0 = 1e5;
phase0 = 0;
delay = [0.001, 0.003, 0.005];  % 秒
amp = [1.0, 0.8, 0.5];
phase = [0, pi/4, pi/2];  % 弧度

[y_time, M] = SigGenerateTD(freq, T, fs, amp0, phase0, delay, amp, phase);
```

---

### 5.4 SigGenerateFD

**功能**：通过频域处理生成多径衰落信号

**语法**：
```matlab
[y_freq, M] = SigGenerateFD(signal, fs, delay, amp, phase)
```

**输入参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `signal` | double[] | 原始输入信号（行向量或列向量） |
| `fs` | double | 采样率 (Hz) |
| `delay` | double[P] | 各路径时延（秒） |
| `amp` | double[P] | 各路径幅值 |
| `phase` | double[P] | 各路径相位（弧度） |

**输出参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `y_freq` | double[1×M] | 扩展后的多径信号 |
| `M` | int | 扩展信号采样点数 |

**算法说明**：
1. 构造多径信道频率响应：`H(f) = Σ amp(i) * exp(1j*phase(i)) * exp(-1j*2*pi*f*delay(i))`
2. 频域乘法：`Y(f) = X(f) * H(f)`
3. IFFT 得到时域输出

**使用示例**：
```matlab
signal = randn(1, 10000);  % 随机信号
fs = 44100;
delay = [0, 0.001, 0.002];
amp = [1.0, 0.7, 0.4];
phase = [0, 0, 0];

[y_freq, M] = SigGenerateFD(signal, fs, delay, amp, phase);
```

---

## 6. 文件写入工具

### 6.1 FileMaker

**功能**：生成 Bellhop 声场计算所需的全套环境文件

**语法**：
```matlab
FileMaker(ETOPO, WOA, FileName, Config)
```

**输入参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `ETOPO` | struct | ETOPO地形数据结构体 |
| `WOA` | struct | WOA23声速剖面数据结构体 |
| `FileName` | char | 输出文件名前缀 |
| `Config` | struct | 配置参数结构体 |

**Config 结构体字段**：
| 字段 | 说明 |
|------|------|
| `Config.Loc.coordS` | 起点坐标（`.lon`, `.lat`） |
| `Config.Loc.coordE` | 终点坐标（`.lon`, `.lat`） |
| `Config.Source.SourceRange` | 声源距离 (km) |
| `Config.Source.SourceDepth` | 声源深度 (m) |
| `Config.Source.freq` | 中心频率 (Hz) |
| `Config.Source.freqvec` | 频率向量 (Hz) |
| `Config.Source.timeIdx` | 时间索引 |
| `Config.Receiver.ReceiveDepth` | 接收深度数组 (m) |
| `Config.Receiver.ReceiveRange` | 接收距离数组 (km) |
| `Config.Cal.Bdry` | 边界条件配置 |
| `Config.Cal.Beam` | 波束配置 |
| `Config.Cal.top_sea_state_level` | 海况等级 |
| `Config.Cal.bottom_base_type` | 海底类型 |
| `Config.Cal.bottom_alpha_b` | 底质吸收系数 |
| `Config.Cal.mesoscale` | 中尺度现象配置 |

**输出文件**：
- `FileName.env` - Bellhop 环境文件
- `FileName.bty` - 海底地形文件
- `FileName.ssp` - 声速剖面文件
- `FileName.trc` - 海面反射系数文件
- `FileName.brc` - 海底反射系数文件

**使用示例**：
```matlab
% 加载数据
[ETOPO, WOA] = load_data(OceanDataPath, ETOPOName, WOAName);

% 配置参数
Config.Loc.coordS.lon = 115.0;
Config.Loc.coordS.lat = 20.0;
Config.Loc.coordE.lon = 116.0;
Config.Loc.coordE.lat = 21.0;
Config.Source.SourceRange = 0;
Config.Source.SourceDepth = 10;
Config.Source.freq = 500;
Config.Source.freqvec = [100, 500, 1000];
Config.Source.timeIdx = 1;
Config.Receiver.ReceiveDepth = [10, 20, 30];
Config.Receiver.ReceiveRange = [5, 30, 60];
% ... 其他配置

% 生成环境文件
FileMaker(ETOPO, WOA, 'ENV_1_Rr5Km', Config);
```

---

### 6.2 write_env

**功能**：写入 Bellhop 环境文件（*.env）

**语法**：
```matlab
write_env(envfil, model, TitleEnv, freq, SSP, Bdry, Pos, Beam, cInt, RMax)
```

**输入参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `envfil` | char | 环境文件名（可含或不含 .env 扩展名） |
| `model` | char | 模型名称（'BELLHOP', 'KRAKEN' 等） |
| `TitleEnv` | char | 标题描述 |
| `freq` | double | 频率 (Hz) |
| `SSP` | struct | 声速剖面结构体 |
| `Bdry` | struct | 边界条件结构体 |
| `Pos` | struct | 位置参数结构体 |
| `Beam` | struct | 波束参数结构体 |
| `cInt` | struct | 相速度范围（KRAKEN 等模型） |
| `RMax` | double | 最大距离 (km) |

**输出文件**：`envfil.env`（ASCII格式）

---

### 6.3 write_bty

**功能**：写入海底地形文件（*.bty）

**语法**：
```matlab
write_bty(envfil, interp_type, bathm)
```

**输入参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `envfil` | char | 文件名前缀（不含扩展名） |
| `interp_type` | char | 插值类型（如 `'LS'` - 线性插值） |
| `bathm` | struct | 海底地形结构体 |
| `bathm.r` | double[] | 海底地形距离向量 (km) |
| `bathm.d` | double[] | 海底地形海深向量 (m) |

**输出文件**：`envfil.bty`（ASCII格式）

**使用示例**：
```matlab
bathm.r = [0, 10, 20, 30];
bathm.d = [100, 150, 200, 180];
write_bty('test', '''LS''', bathm);
```

---

### 6.4 write_ssp

**功能**：写入声速剖面文件（*.ssp）

**语法**：
```matlab
write_ssp(filename, rkm, SSP)
```

**输入参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `filename` | char | 文件名前缀（不含扩展名） |
| `rkm` | double[] | 距离向量 (km) |
| `SSP` | double[Nz×Nr] | 声速矩阵（深度×距离） |

**输出文件**：`filename.ssp`（ASCII格式）

**文件格式**：
```
Npts
r1 r2 r3 ... rN
c11 c12 c13 ... c1N
c21 c22 c23 ... c2N
...
cM1 cM2 cM3 ... cMN
```

**使用示例**：
```matlab
rkm = linspace(0, 100, 50);  % 50个距离点
SSP_matrix = SSP.c;  % 深度×距离矩阵
write_ssp('test', rkm, SSP_matrix);
```

---

## 7. 高级功能

### 7.1 声速计算辅助函数

项目内部使用 `sound_speed` 函数根据温度、盐度和深度计算声速：

**功能**：根据温盐深计算声速（UNESCO公式）

**语法**（内部函数，未在单独文件中定义）：
```matlab
c = sound_speed(T, S, z)
```

**参数说明**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| `T` | double | 温度 (°C) |
| `S` | double | 盐度 (PSU) |
| `z` | double | 深度 (m) |
| `c` | double | 声速 (m/s) |

---

## 8. 完整工作流程示例

### 8.1 基础环境文件生成流程

```matlab
%% 步骤1: 加载海洋数据
OceanDataPath = 'c:\DataBase\code\matlab\UASignalAugmentor\data\OceanData';
ETOPOName = 'ETOPO2022.mat';
WOAName = 'woa23_%02d.mat';
[ETOPO, WOA23] = load_data(OceanDataPath, ETOPOName, WOAName);

%% 步骤2: 设置位置参数
coordS.lon = 115.0;
coordS.lat = 20.0;
coordE = [];
R = 100;  % km
azi = 45;  % 度
[coordS, coordE, R, azi] = coord_proc(coordS, coordE, R, azi);

%% 步骤3: 配置参数
Config.Loc.coordS = coordS;
Config.Loc.coordE = coordE;
Config.Source.SourceRange = 0;
Config.Source.SourceDepth = 10;
Config.Source.freq = 500;
Config.Source.freqvec = [100, 200, 500, 1000];
Config.Source.timeIdx = 1;  % 一月份
Config.Receiver.ReceiveDepth = [10, 20, 30];
Config.Receiver.ReceiveRange = [5, 30, 60];

% 边界条件
Config.Cal.Bdry.Top.Opt = 'CFFT';
Config.Cal.Bdry.Bot.Opt = 'F*';
Config.Cal.Bdry.Bot.HS.alphaR = 1500;
Config.Cal.Bdry.Bot.HS.betaR = 0;
Config.Cal.Bdry.Bot.HS.rho = 1;
Config.Cal.Bdry.Bot.HS.alphaI = 0;
Config.Cal.Bdry.Bot.HS.betaI = 0;

% 海况和海底
Config.Cal.top_sea_state_level = 3;
Config.Cal.bottom_base_type = 'IMG';
Config.Cal.bottom_alpha_b = 0.05;

% 波束参数
Config.Cal.Beam.RunType = 'AB';
Config.Cal.Beam.Nbeams = 0;
Config.Cal.Beam.alpha = [-90, 90];
Config.Cal.Beam.deltas = 0;
Config.Cal.Beam.epmult = 0.3;
Config.Cal.Beam.rLoop = 1;
Config.Cal.Beam.Nimage = 1;
Config.Cal.Beam.Ibwin = 1;
Config.Cal.Beam.Type = 'CS';

% 中尺度现象（可选）
Config.Cal.mesoscale.type = 'none';
Config.Cal.mesoscale.params = [];

%% 步骤4: 生成环境文件
FileMaker(ETOPO, WOA23, 'ENV_Test', Config);
```

---

### 8.2 音频信号处理流程

```matlab
%% 步骤1: 提取音频频率成分
audioname = 'ship_signal.wav';
FreqRange = [10, 5000];
cut_Tlength = 1;
[fs, Ndelay, Analyrecord, Analy_freq] = wavfreq(audioname, FreqRange, cut_Tlength);

%% 步骤2: 幅值筛选
threshold = 0.05;
[Analyrecord_filtered, Analy_freq_filtered] = wavfilter(Analyrecord, threshold);

%% 步骤3: 保存结果
save('signal_analysis.mat', 'fs', 'Ndelay', 'Analyrecord_filtered', 'Analy_freq_filtered');
```

---

### 8.3 接收信号合成流程

```matlab
%% 步骤1: 加载到达结构数据
load('ENV_ARR_less.mat', 'ARR');  % 从 A4 生成

%% 步骤2: 加载信号频率数据
load('signal_analysis.mat', 'Analyrecord_filtered', 'Analy_freq_filtered');

%% 步骤3: 设置参数
freq = Analy_freq_filtered(1);  % 选择一个频率
T = 1;  % 持续时间
fs = 52734;  % 采样率
amp0 = 1e5;  % 源强度
phase0 = Analyrecord_filtered(1).phase(1);  % 初相位

% 从 ARR 获取声线信息
delay = ARR(1, 1).Delay;
amp = ARR(1, 1).Amp;
phase = ARR(1, 1).phase;

%% 步骤4: 合成接收信号
[y_time, M] = SigGenerateTD(freq, T, fs, amp0, phase0, delay, amp, phase);
tgsig = real(y_time);

%% 步骤5: 保存结果
tgt = (0:length(tgsig)-1) / fs;
save('received_signal.mat', 'tgsig', 'tgt');
```

---

## 9. 常见问题与注意事项

### 9.1 数据要求
- **ETOPO 数据**：需要包含 `.Lon`, `.Lat`, `.Altitude` 字段
- **WOA23 数据**：需要17个文件（01-12月 + 13-16季 + 00年）
- **音频文件**：支持 MATLAB `audioread` 函数支持的格式（.wav, .mp3等）

### 9.2 坐标系统
- **经度**：东经为正（0-360° 或 -180-180°）
- **纬度**：北纬为正（-90-90°）
- **方位角**：正北为0°，顺时针增大（0-360°）

### 9.3 单位约定
| 物理量 | 单位 |
|--------|------|
| 距离 | km（文件写入）/ m（内部计算） |
| 深度 | m |
| 频率 | Hz |
| 声速 | m/s |
| 时间 | s |
| 相位 | rad（弧度） |
| 角度 | degree（度） |

### 9.4 性能优化建议
1. **大数据处理**：使用数据缓存避免重复加载
2. **并行计算**：在 A4、A5 步骤使用 `parfor` 加速
3. **内存管理**：及时清除不需要的大型变量
4. **文件I/O**：批量处理减少文件打开/关闭次数

### 9.5 错误处理
大多数函数会在输入无效时抛出错误，建议使用 try-catch 进行错误捕获：

```matlab
try
    FileMaker(ETOPO, WOA23, FileName, Config);
catch ME
    fprintf('错误: %s\n', ME.message);
    fprintf('位置: %s (行 %d)\n', ME.stack(1).name, ME.stack(1).line);
end
```

---

## 10. 版本信息

**文档版本**：1.0  
**最后更新**：2025-12-10  
**适用项目版本**：UASignalAugmentor v1.0  
**作者**：猫猫头

---

## 附录 A：快速参考表

### A.1 主要函数分类

| 功能类别 | 函数名 | 主要用途 |
|----------|--------|----------|
| **数据加载** | `load_data` | 加载 ETOPO + WOA23 |
| | `get_env` | 提取海深和声速剖面 |
| | `get_envInfo` | 提取温盐深数据 |
| **坐标处理** | `coord_proc` | 坐标/距离/方位转换 |
| | `get_bathm` | 插值获取海深 |
| **声速处理** | `add_mesoscale` | 添加中尺度现象 |
| **边界条件** | `ReCoeTop` | 海面反射系数 |
| | `RefCoeBw` | 海底反射系数 |
| | `get_boundary_speed` | 提取边界声速 |
| **信号分析** | `wavfreq` | 音频频率提取 |
| | `wavfilter` | 频率分量筛选 |
| **信号合成** | `SigGenerateTD` | 时域多径合成 |
| | `SigGenerateFD` | 频域多径合成 |
| **文件写入** | `FileMaker` | 生成全套环境文件 |
| | `write_env` | 写入 .env 文件 |
| | `write_bty` | 写入 .bty 文件 |
| | `write_ssp` | 写入 .ssp 文件 |

---

### A.2 文件扩展名说明

| 扩展名 | 说明 | 生成函数 |
|--------|------|----------|
| `.env` | Bellhop 环境文件 | `write_env` |
| `.bty` | 海底地形文件 | `write_bty` |
| `.ssp` | 声速剖面文件 | `write_ssp` |
| `.trc` | 海面反射系数文件 | `ReCoeTop` |
| `.brc` | 海底反射系数文件 | `RefCoeBw` |
| `.arr` | 声线到达结构文件 | Bellhop 输出 |
| `.mat` | MATLAB 数据文件 | `save` |

---

## 附录 B：联系与支持

如有疑问或需要技术支持，请联系项目维护者。

**项目路径**：`c:\DataBase\code\matlab\UASignalAugmentor`

---

**文档结束**
