# UASignalAugmentor 项目说明文档

## 项目概述

**UASignalAugmentor** 是一个**端到端的水声信号合成与增强系统**。该项目通过读取真实的舰船（或其他）音频信号，提取其频率成分，在真实的海洋环境（基于 ETOPO 和 WOA23 数据库）中运行 **Bellhop** 声学传播模型，最终在不同距离和深度合成接收信号，用于不同海域类型（浅海/过渡区/深海）的声学仿真。

**核心功能**：给定干净的源音频 + 海洋环境数据库 → 生成多种海洋条件下的真实接收信号。

---

## 项目结构

### 主要脚本（工作流程）

#### 配置文件生成器
- **`ConfigMaker.m`** - 生成 `Config*.mat` 配置文件，描述站点位置、声源参数和 Bellhop 计算参数

#### A1-A5 处理链（核心流程）
- **`A1WavTransformer.m`** - 步骤1：**分析原始音频**，提取频率成分
- **`A2ENVmaker.m`** - 步骤2：**生成基础 Bellhop 环境模板**（多站点×多距离）
- **`A3ENVDuplicator.m`** - 步骤3：**为每个频率复制环境文件**，重写 `.env` 文件并重新计算反射系数
- **`A4ArrProcessor.m`** - 步骤4：**处理 Bellhop `.arr` 文件**，压缩声线到达结构为 mat/json 格式
- **`A5RecSigSynthesizer.m`** - 步骤5：**合成时域接收信号**，使用声线到达结构和源信号频谱

#### 辅助工具
- **`sspmake.m`** - **独立的二维声速剖面（SSP）生成工具**，可选添加中尺度现象（涡旋/内波）

---

### 辅助函数库（`function/` 文件夹）

#### 环境与数据库工具
- `load_data.m` - 加载 ETOPO 地形 + WOA23 声速数据
- `get_env.m`, `get_envInfo.m` - 构建环境场、声速剖面和海底地形
- `get_bathm.m` - 提取海底深度
- `coord_proc.m` - 大圆航线坐标计算（从起点到终点的距离/方位角）

#### Bellhop 文件写入工具
- `FileMaker.m` - 核心函数，写入 `.env`, `.bty`, `.ssp`, `.trc`, `.brc` 文件
- `write_env.m`, `write_bty.m`, `write_ssp.m` - 底层 Bellhop 文件写入函数

#### 边界与反射系数
- `ReCoeTop.m` - 海面反射系数（粗糙海面，基于 `Cal.top_sea_state_level`）
- `RefCoeBw.m` - 海底反射系数（基于 `Cal.bottom_base_type` / `Cal.bottom_alpha_b`）
- `get_boundary_speed.m` - 从 `.env` 文件文本中提取表面和海底声速

#### 信号处理工具
- `wavfreq.m` - 从 `.wav` 文件提取频率成分（fs, Ndelay, Analyrecord, Analy_freq）
- `wavfilter.m` - 阈值过滤频率成分
- `SigGenerateTD.m` - 为单个频率线合成**时域信号**（基于声线到达结构）
- `SigGenerateFD.m` - 频域变体（当前主流程未使用）

#### 中尺度现象
- `add_mesoscale.m` - 在声速剖面上叠加**涡旋**或**内波**结构

---

### Bellhop 引擎集成（`CallBell/` 文件夹）

- `bellhop.exe` - Bellhop 可执行文件
- `BellParallelLin.cpp`, `BellParallelWin.cpp`, `c++time_new (1).cpp` - C++ 辅助工具，用于批量/并行运行 Bellhop（处理大量 `.env` 文件）

---

### 数据文件夹结构（从代码推断）

```
data/
├── raw/
│   ├── Class A/*.wav        # 输入音频（按类别）
│   ├── Class B/*.wav
│   ├── Class C/*.wav
│   ├── Class D/*.wav
│   └── Class E/*.wav
├── processed/               # A1 生成的频率分析结果 + A5 合成的信号
│   ├── Analy_freq_all.mat   # 全局频率汇总
│   ├── Class A_file1.mat    # 单个音频频率分析
│   └── ...
├── OriginEnvPack/           # 环境文件包
│   ├── Shallow/             # 浅海区域
│   │   ├── ENV1/
│   │   │   ├── Rr1/EnvTemplate/  # 距离1
│   │   │   ├── Rr2/EnvTemplate/  # 距离2
│   │   │   └── Rr3/EnvTemplate/  # 距离3
│   │   ├── ENV2/
│   │   └── ...
│   ├── Transition/          # 过渡区域
│   └── Deep/                # 深海区域
└── OceanData/               # 全球海洋数据库
    ├── ETOPO2022.mat        # 地形数据
    └── woa23_XX.mat         # WOA23 声速剖面数据（按月份）
```

---

## 主处理流程详解（A1–A5）

### 步骤 0：配置生成 - `ConfigMaker.m`

**目的**：定义海洋站点位置和 Bellhop 计算参数，保存为 `Config{Shallow|Transition|Deep}.mat`。

**关键输出**：配置文件包含三个结构体
1. **`Site_loc`** - 站点配置
   - `zone` - 海域类型：`'Shallow'`（浅海）、`'Transition'`（过渡区）或 `'Deep'`（深海）
   - `lat`, `lon` - 站点位置数组（纬度、经度）
   - `ReceiveRange` - 接收距离列表（km）
   - `ReceiveDepth` - 接收深度列表（m）
   - `outputPath` - 输出路径

2. **`Source`** - 声源配置
   - `SourceRange`, `SourceDepth`, `azi` - 声源位置和方位角
   - `freq` - 中心频率
   - `freqvec` - 宽带频率向量（用于反射系数计算）
   - `timeIdx` - WOA23 时间索引（月份/季节/年平均）

3. **`Cal`** - 计算参数
   - 海面条件：`top_sea_state_level`（海况等级）、`Bdry.Top.Opt`
   - 海底边界：`Bdry.Bot.*` 和 `bottom_*` 参数
   - Bellhop 运行参数：`Beam.RunType`、`Beam.Nbeams`、`alpha` 角度范围等

**使用说明**：
- 当前脚本默认设置 `ZoneName = 'Deep'`
- 切换区域会改变站点集和接收配置

---

### 步骤 1：音频分析 - `A1WavTransformer.m`

**功能**：从原始音频中提取频率成分

**处理流程**：
1. 读取 `data\raw\Class A...E` 中的 `.wav` 文件
2. 对每个文件：
   - 调用 `wavfreq` 对时间序列进行分段，提取频率-幅值-相位（`Analyrecord`）
   - 调用 `wavfilter` 对小幅值进行阈值过滤（减少存储/噪声）

**输出**：
- **单个文件结果**：`data\processed\Class A_filename.mat`
  - 包含：`fs`（采样率）、`Ndelay`（分段索引）、`Analyrecord`（频率记录）、`Analy_freq`（频率数组）
- **全局频率汇总**：`data\processed\Analy_freq_all.mat`
  - 包含：`Analy_freq_all`（所有音频的频率并集）

**作用**：定义需要通过海洋信道仿真的**频率集合**

---

### 步骤 2：基础环境模板生成 - `A2ENVmaker.m`

**功能**：为每个站点和接收距离生成 Bellhop 环境文件模板

**处理流程**：
1. 加载环境数据库：
   - `data\OceanData\ETOPO2022.mat`（地形）
   - `woa23_%02d.mat`（声速剖面）
   - 通过 `load_data` 函数加载

2. 加载配置文件：
   - 当前配置路径：`G:\code\matlab\UASignalAugmentor\data\OriginEnvPack`（**需要修改为实际路径**）
   - `ConfigName = 'ConfigDeep.mat'`（可切换为 Shallow/Transition）

3. 对每个站点 `i` 和每个接收距离 `j`：
   - 通过 `coord_proc` 计算终点坐标
   - 构建 `Config_out`（Cal, Source, Receiver, Loc）
   - 调用 `FileMaker` 写入环境文件：
     - `ENV_i_Rr{R}Km.env`
     - `ENV_i_Rr{R}Km.bty`（海底地形）
     - `ENV_i_Rr{R}Km.ssp`（声速剖面）
     - `ENV_i_Rr{R}Km.trc`（海面反射系数）
     - `ENV_i_Rr{R}Km.brc`（海底反射系数）

**输出路径**：`OriginEnvPack\ZoneName\ENVi\Rrj\EnvTemplate\`

**作用**：创建**每个站点×距离的基础 Bellhop 环境**（使用气候态数据）

---

### 步骤 3：环境文件频率扩展 - `A3ENVDuplicator.m`

**功能**：将基础环境文件扩展到所有信号频率

**处理流程**：
1. 加载：
   - `Config{Zone}.mat`（区域配置）
   - `Analy_freq_all.mat`（A1 生成的全局频率）

2. 对每个区域文件夹（如 `Deep\ENV1\Rr1\EnvTemplate`）：
   - 读取基础 `ENV_...env` 文件
   - 使用 `get_boundary_speed` 提取**表面和海底声速**
   - 对 `Analy_freq_all` 中的每个频率：
     - 克隆 `.env` 文件，重写频率行（第2行）为该频率值
     - 复制 `.bty` 和 `.ssp` 文件
     - 调用反射系数计算函数：
       - `ReCoeTop(freq, ssp_top, Cal.top_sea_state_level, NewFileName)` → 生成 `.trc`
       - `RefCoeBw(bottom_type, NewFileName, freq, ssp_bot, Cal.bottom_alpha_b)` → 生成 `.brc`

3. 生成 `env_files_list.txt` 列出所有 `test_i` 文件名

4. 可选：打包所有文件为 `ENVall_files_YYYYMMDD.tar.gz`（使用 shell `tar` 命令）

**输出**：
- 每个频率一组文件：`test_1.env`, `test_1.bty`, `test_1.ssp`, `test_1.trc`, `test_1.brc`
- 环境文件列表：`env_files_list.txt`

**作用**：将**每个环境模板**扩展为**多个频率特定的环境**，与 `Analy_freq_all` 对齐

---

### 步骤 4：声线到达结构处理 - `A4ArrProcessor.m`

**前提**：已在所有 `test_i.env` 上运行 Bellhop（通过 `bellhop.exe` 或远程集群），生成 `test_i.arr` 文件

**处理流程**：
1. 对每个区域（`Shallow`, `Transition`, `Deep`）、每个站点、每个距离：
   - 读取 `env_files_list.txt` 获取所有环境文件名
   - 对每个 `newfilename{m}`：
     - 使用 `read_arrivals_asc` 打开 `test_i.arr`
     - 对每个接收深度：
       - 按时延排序声线
       - 提取幅值、时延、相位
       - 阈值过滤（幅值 >= 0.05 × 最大值）
       - 存储到 `ARR(m, n)` 结构体，包含字段：`Amp`, `Delay`, `phase`, `freq`

2. 保存：
   - `ENV_ARR_less.mat` - 压缩的 ARR 结构体（MATLAB 格式）
   - `ENV_ARR_less.json` - JSON 导出（供非 MATLAB 使用）

**作用**：将 Bellhop 输出压缩为**紧凑的、机器友好的声线到达描述**

---

### 步骤 5：接收信号合成 - `A5RecSigSynthesizer.m`

**功能**：使用声线到达结构和源信号频谱合成时域接收信号

**处理流程**：
1. 加载：
   - `Analy_freq_all` 和所有单个信号的 `.mat` 文件（从 `data\processed`）
   - 对每个环境文件夹（区域/站点/距离），加载 `ENV_ARR_less.mat`

2. 对每个环境、每个接收深度、每个源信号：
   - 将源频率 `Analy_freq` 与 `Analy_freq_all` 对齐，选择匹配的 ARR 条目
   - 计算所有频率的 `MAXdelay` 和 `MINdelay`，确定输出长度
   - 随机选择 **Nsel（=10 或全部）** 个连续源信号段（`Analyrecord`）
   - 对每个选择的段：
     - 遍历频率：
       - 使用 `SigGenerateTD(freq, Ndelay_d, fs, originAmp, phase, delay0, amp0, phase0)` 构建时域贡献
         - 其中 `originAmp = Amp_source * tar_amp`
       - 根据适当的时延偏移放入 `Dsig`
     - 累加到 `tgsig`
   - 去除尾部零值，取实部
   - 保存 `tgsig` 和 `tgt` 到 `NewSig` 文件夹
     - 文件名格式：`signalName_Rd_{depth}_new.mat`

**输出**：每个环境/深度/源文件对应一个接收信号文件

**作用**：生成**物理一致的接收时域信号**，适用于各种海洋环境、深度和原始源文件

---

## `sspmake.m`：SSP 与中尺度工具

**功能**：SSP 诊断和研究工具（独立于 A1-A5 流程）

**主要用途**：
- 加载 ETOPO + WOA23
- 定义起点、方位角、距离网格
- 提取二维声速剖面 `SSP.c(r,z)`
- 可选添加中尺度现象：
  - **`eddy`**（涡旋） - 高斯涡结构，参数：(rc, zc, DR, DZ, DC)
  - **`internal_wave`**（内波） - 内波使温跃层弯曲
- 可视化 SSP（使用 `pcolor`）
- 可选输出 `.ssp` 文件

**用途**：在生成完整 Bellhop 环境之前，**探索海洋环境和中尺度效应**

---

## 实际使用流程

### 1. 准备数据和配置

1. **准备音频数据**
   - 将原始 `.wav` 文件放入 `data\raw\Class A...E` 文件夹

2. **调整配置**
   - 修改 `ConfigMaker.m`：
     - 站点坐标（`lat`, `lon`）
     - 海域类型（`ZoneName`）
     - 接收距离和深度（`ReceiveRange`, `ReceiveDepth`）
     - 声源参数（`Source.*`）
     - 海况等级和底质参数（`Cal.*`）
   - 运行 `ConfigMaker.m` 生成配置文件

3. **准备海洋数据**
   - 确保 `data\OceanData` 包含：
     - `ETOPO2022.mat`（地形数据）
     - `woa23_XX.mat`（声速剖面数据）

### 2. 生成环境文件

1. **修改路径**
   - 在 `A2ENVmaker.m` 和 `sspmake.m` 中：
     - 将硬编码路径 `G:\code\...` 修改为实际项目路径
     - 例如：`c:\DataBase\code\matlab\UASignalAugmentor\data\OriginEnvPack`

2. **运行处理链**
   ```matlab
   % 步骤1：提取音频频率
   A1WavTransformer
   % 输出: Analy_freq_all.mat + 单个信号 .mat
   
   % 步骤2：生成基础环境模板
   A2ENVmaker
   % 输出: ENV_i_Rrj 模板文件
   
   % 步骤3：频率扩展
   A3ENVDuplicator
   % 输出: test_i 环境文件 + 反射系数
   ```

### 3. 运行 Bellhop 计算

使用以下方式之一运行 Bellhop：
- **本地**：使用 `CallBell\bellhop.exe`
- **集群**：使用并行脚本（`BellParallelLin.cpp` / `BellParallelWin.cpp`）

对每个 `test_i.env` 计算声场，生成 `test_i.arr`

### 4. 后处理和信号合成

```matlab
% 步骤4：处理到达结构
A4ArrProcessor
% 输出: ENV_ARR_less.mat / .json

% 步骤5：合成接收信号
A5RecSigSynthesizer
% 输出: 多个 {signal}_Rd_{depth}_new.mat 接收信号
```

---

## 关键参数说明

### ConfigMaker.m 参数

| 参数 | 说明 | 示例值 |
|------|------|--------|
| `ZoneName` | 海域类型 | `'Shallow'` / `'Transition'` / `'Deep'` |
| `Site_loc.lat/lon` | 站点经纬度（度） | `[17.80, 21.90, 13.90, ...]` |
| `ReceiveRange` | 接收距离（km） | `[5, 30, 60]` |
| `ReceiveDepth` | 接收深度（m） | `[25, 50, 100, 300]` |
| `Source.freq` | 中心频率（Hz） | `500` |
| `Source.timeIdx` | 时间索引 | `1-12`(月份), `13-16`(季节), `17`(年平均) |
| `Cal.top_sea_state_level` | 海况等级 | `0-9` |
| `Cal.bottom_base_type` | 海底类型 | `'IMG'` |
| `Cal.Beam.RunType` | 运行类型 | `'AB'`(到达结构) |

### A1WavTransformer.m 参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `threshold` | 幅值阈值 | `0.05` |
| `cut_Tlength` | 分段时间长度（秒） | `1` |
| `FreqRange` | 频率范围（Hz） | `[10, 5000]` |

### A5RecSigSynthesizer.m 参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `Amp_source` | 源强度 | `1e5` |
| `fs` | 采样率（Hz） | `52734` |
| `Nsel` | 选择的连续段数 | `10`（或全部） |

---

## 技术特点

### 1. 多语言集成
- **MATLAB** - 主要处理流程和信号处理
- **C++** - Bellhop 引擎和并行计算工具
- **Python** - 环境数据预处理（`py\EnvProcess`）和替代实现（`py\UASignalAugmentor`）

### 2. 真实海洋环境
- **ETOPO2022** - 全球高分辨率地形数据
- **WOA23** - 世界海洋图集 2023 声速剖面
- 支持月份、季节和年平均声速剖面

### 3. 物理准确性
- 基于 **Bellhop** 射线/波束追踪模型
- 频率相关的反射系数计算
- 考虑海况等级的海面粗糙度
- 多种海底类型和吸收系数

### 4. 中尺度现象支持
- **涡旋**（高斯涡模型）
- **内波**（温跃层变形）
- 通过 `add_mesoscale.m` 实现

### 5. 批量处理能力
- 支持多站点、多距离、多深度
- 自动化频率扩展
- 并行 Bellhop 计算支持

---

## 注意事项

### 路径配置
⚠️ **重要**：当前代码中包含硬编码路径，需要修改：
- `A2ENVmaker.m` 第 51 行：`OriginEnvPackPath = 'G:\code\...'`
- `sspmake.m` 第 29 行：`OceanDataPath = 'G:\code\...'`

建议修改为相对路径或实际工作路径。

### 数据要求
- **ETOPO2022.mat** 和 **woa23_XX.mat** 文件较大，需提前准备
- 音频文件需按类别组织在 `data\raw\Class X` 文件夹中
- 确保有足够的磁盘空间存储环境文件（大量频率×站点×距离）

### 计算资源
- Bellhop 计算可能耗时较长，建议使用：
  - 并行计算（`BellParallelWin.cpp`）
  - 远程集群
- A5 合成步骤使用 `parfor` 并行循环，需要 MATLAB Parallel Computing Toolbox

---

## 输出文件说明

### A1 输出
```
data/processed/
├── Analy_freq_all.mat          # 全局频率数组
├── Class A_file1.mat           # 单个音频分析结果
│   ├── fs                      # 采样率
│   ├── Ndelay                  # 分段时间索引
│   ├── Analyrecord             # 频率记录（freq, Amp, phase）
│   └── Analy_freq              # 频率数组
└── ...
```

### A2-A3 输出
```
data/OriginEnvPack/Deep/ENV1/Rr1/EnvTemplate/
├── ENV_1_Rr5Km.env             # 基础环境文件
├── ENV_1_Rr5Km.bty             # 地形文件
├── ENV_1_Rr5Km.ssp             # 声速剖面
├── ENV_1_Rr5Km.trc             # 海面反射系数
├── ENV_1_Rr5Km.brc             # 海底反射系数
├── test_1.env                  # 频率1环境文件
├── test_1.bty
├── test_1.ssp
├── test_1.trc
├── test_1.brc
├── test_2.env                  # 频率2环境文件
├── ...
└── env_files_list.txt          # 环境文件列表
```

### A4 输出
```
ENV_ARR_less.mat                # 到达结构（MATLAB格式）
    ARR(m,n).Amp                # 声线幅值数组
    ARR(m,n).Delay              # 声线时延数组（秒）
    ARR(m,n).phase              # 声线相位数组（弧度）
    ARR(m,n).freq               # 频率（Hz）

ENV_ARR_less.json               # 到达结构（JSON格式）
```

### A5 输出
```
NewSig/
├── Class_A_file1_Rd_25_new.mat     # 深度25m接收信号
│   ├── tgsig                       # 时域信号数据
│   └── tgt                         # 时间序列
├── Class_A_file1_Rd_50_new.mat     # 深度50m接收信号
└── ...
```

---

## 常见问题

### 1. 如何切换海域类型？
在 `ConfigMaker.m` 中修改 `ZoneName` 变量：
```matlab
ZoneName = 'Shallow';  % 或 'Transition' / 'Deep'
```

### 2. 如何添加新站点？
在 `ConfigMaker.m` 的对应海域配置中添加经纬度：
```matlab
Site_loc.lat = [17.80, 21.90, 13.90, 新纬度];
Site_loc.lon = [117.90, 122.50, 116.20, 新经度];
```

### 3. 如何修改接收深度？
在 `ConfigMaker.m` 中修改 `ReceiveDepth`：
```matlab
Site_loc.ReceiveDepth = [25, 50, 100, 300, 新深度];
```

### 4. 计算太慢怎么办？
- 减少频率数量（提高 `A1WavTransformer.m` 中的 `threshold`）
- 减少站点或距离数量
- 使用并行 Bellhop 工具
- 在高性能计算集群上运行

### 5. 如何添加中尺度现象？
在 `ConfigMaker.m` 中配置：
```matlab
Cal.mesoscale.type = 'eddy';  % 或 'internal_wave'
Cal.mesoscale.params.rc = 100;  % 涡心位置（km）
Cal.mesoscale.params.zc = 600;  % 涡心深度（m）
Cal.mesoscale.params.DR = 70;   % 水平尺度（km）
Cal.mesoscale.params.DZ = 400;  % 竖直尺度（m）
Cal.mesoscale.params.DC = -40;  % 强度（m/s）
```

---

## 扩展阅读

### Python 版本
项目包含 Python 实现版本：`py\UASignalAugmentor`
- 提供类似功能的 Python 接口
- 详见 `py\UASignalAugmentor\README.md`

### 相关项目
- `matlab\arr_test` - 早期版本的处理脚本
- `matlab\NoiseGenerate` - 噪声生成工具
- `matlab\underwateracoustic` - 水声特性分析工具

---

## 总结

**UASignalAugmentor** 是一个完整的水声信号增强系统，具有以下特点：

✅ **端到端流程** - 从原始音频到合成接收信号的完整链路  
✅ **真实环境** - 基于全球海洋数据库和物理模型  
✅ **灵活配置** - 支持多种海域类型、站点和参数  
✅ **批量处理** - 自动化生成大量训练数据  
✅ **物理准确** - 基于 Bellhop 模型和频率相关的边界条件  

该系统特别适用于：
- 水声信号处理研究
- 深度学习训练数据生成
- 海洋环境声学特性分析
- 声纳系统性能仿真

---

**文档版本**：1.0  
**最后更新**：2025-12-10  
**作者**：猫猫头
